---
- name: Update user .bashrc
  blockinfile:
    block: "{{ lookup('file', user_bashrc_file_path) }}"
    path: "{{ ansible_user_dir }}/.bashrc"
    backup: yes
    marker: "# {mark} ANSIBLE MANAGED BLOCK"

- name: Update xkbrc
  ini_file:
    path: "{{ ansible_user_dir }}/.config/kxkbrc"
    section: Layout
    option: "{{ item.key }}"
    value: "{{ item.value }}"
  loop: "{{ layout_section | dict2items }}"
  # Not using ini lookup as input since it does not return the keys, only the values
  vars:
    layout_section:
      DisplayNames: ","
      LayoutList: "us,il"
      LayoutLoopCount: "-1"
      Model: "pc101"
      Options: "grp:alt_shift_toggle,grp:lalt_lshift_toggle"
      ResetOldOptions: "true"
      ShowFlag: "false"
      ShowLabel: "true"
      ShowLayoutIndicator: "true"
      ShowSingle: "false"
      SwitchMode: "Global"
      Use: "true"
  when: configure_kde

- name: Configure git user name
  git_config:
    name: user.name
    value: Or Bin
    scope: global


- name: Configure git aliases
  git_config:
    name: "alias.{{ item.key }}"
    value: "{{ item.value }}"
    scope: global
  loop: "{{ aliases | dict2items }}"
  vars:
    aliases:
      co: checkout

- name: Configure plasma desktop applets
  template:
    src: "{{playbook_dir}}/configuration/plasma-org.kde.plasma.desktop-appletsrc"
    dest: "{{ ansible_user_dir }}/.config/plasma-org.kde.plasma.desktop-appletsrc"
  when: configure_kde

# TODO conditionally add slack to taskbar (in plasma-org.kde.plasma.desktop-appletsrc)

- name: Configure KDE
  shell: |
    lookandfeeltool -a org.kde.breezedark.desktop

    kwriteconfig5 --file kwinrc --group TabBox --key LayoutName thumbnail_grid
    kwriteconfig5 --file kglobalshortcutsrc --group plasmashell --key "activate widget 4" "Meta+F1,none,Activate Application Launcher Widget"
    
    kwriteconfig5 --file kglobalshortcutsrc --group kwin --key "Window Quick Tile Top" "none,none,Quick Tile Window to the Top"
    kwriteconfig5 --file kglobalshortcutsrc --group kwin --key "Window Maximize" "Meta+Up,Meta+Up,Maximize Window"

    kwin_x11 --replace &
    restart_kde_app_with_sleep kglobalaccel5
    restart_kde_app plasmashell
  when: configure_kde

- name: Configure GitHub CLI
  shell: gh config set git_protocol ssh