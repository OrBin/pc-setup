---
- name: Download GitHub CLI GPG key public ring
  get_url:
    url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
    dest: /usr/share/keyrings/githubcli-archive-keyring.gpg
    mode: "0644"
  become: yes

- name: Add GitHub CLI apt repository into sources list
  apt_repository:
    repo: "deb [arch={{packages_architecture}} signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
    filename: /etc/apt/sources.list.d/github-cli
    update_cache: yes
  become: yes

- name: Install developer tools (apt)
  apt:
    name:
    - gh
    - git
    - nmap
    - wireshark
    - adb
    - postgresql-client
    state: latest
  become: yes

- name: "Evaluate GitHub CLI completion for bash"
  shell: |
    gh completion -s bash | tee $HOME/.gh_bash_completion
    echo 'source $HOME/.gh_bash_completion' >> "{{ user_bash_completion_file_path }}"

- name: "Evaluate GitHub CLI completion for zsh"
  shell: |
    gh completion -s zsh | tee $HOME/.gh_zsh_completion
    echo 'source $HOME/.gh_zsh_completion' >> "{{ user_zsh_completion_file_path }}"


- name: Install developer tools (snap)
  snap:
    name:
    - doctl
    - multipass
    - shellcheck
    - yq
  become: yes

- name: Connect doctl to ssh-keys interface
  shell: snap connect doctl:ssh-keys :ssh-keys
  become: yes

- name: Install Docker
  import_role:
    name: geerlingguy.docker
  vars:
    docker_apt_arch: "{{packages_architecture}}"
    docker_users:
      - "{{ansible_user_id}}"  # Self user (the user running this setup)
  become: yes

- name: Check dive version
  shell: dpkg -s dive | grep '^Version:' | cut -d ' ' -f 2-
  register: installed_dive_version_check_command

- name: Decide if should install dive
  set_fact:
    should_install_dive: "{{ installed_dive_version_check_command is failed or installed_dive_version_check_command.stdout == '' or installed_dive_version_check_command.stdout is version(dive_version, '<') }}"

- name: Install dive
  apt:
    deb: "https://github.com/wagoodman/dive/releases/download/v{{dive_version}}/dive_{{dive_version}}_linux_{{packages_architecture}}.deb"
  become: yes
  when: should_install_dive

- name: Install JetBrains IDEs
  snap:
    name: "{{ jetbrains_ides }}"
    classic: yes
  become: yes
  register: jetbrains_ides_installation

# TODO install IDE extensions (e.g. TabNine)

- name: Check installed VS Code version
  # Expected output is formatted like 1.72.2-1665614327
  shell: dpkg -s code | grep '^Version:' | cut -d ' ' -f 2-
  when: computer_type == "work"
  register: installed_vs_code_version_check_command

- name: Extract installed VS Code version
  set_fact:
    installed_vs_code_version: "{{ installed_vs_code_version_check_command.stdout }}"
  when: computer_type == "work" and installed_vs_code_version_check_command.stdout != ""
  ignore_errors: yes

- name: Check latest VS Code version
  ansible.builtin.uri:
    url: https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64
    follow_redirects: none
    status_code: [302, 304, 307]
  ignore_errors: yes
  when: computer_type == "work"
  register: vs_code_download_probe

- name: Extract latest VS Code version
  # Expected output is formatted like 1.72.2-1665614327
  set_fact:
    latest_vs_code_version: "{{ vs_code_download_probe.location | urlsplit('path') | basename | regex_search(vs_code_deb_file_regexp, '\\1') | first }}"
  when: computer_type == "work" and vs_code_download_probe is succeeded
  ignore_errors: yes

- name: Decide whether VS Code should be installed
  set_fact:
    should_install_vs_code: "{{ installed_vs_code_version is not defined or latest_vs_code_version is not defined or installed_vs_code_version is version(latest_vs_code_version, '<', version_type='semver') }}"
  when: computer_type == "work"

- name: Download VS Code
  get_url:
    url: https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64
    dest: "{{temp_dir}}"
    mode: "0644"
  register: download_vscode
  when: computer_type == "work" and should_install_vs_code

- name: Install VS Code
  apt:
    deb: "{{ download_vscode.dest }}"
  become: yes
  when: computer_type == "work" and should_install_vs_code

- name: Install Postman
  snap:
    name: postman
    channel: "{{postman_snap_channel}}"
  become: yes

- name: Download and extract AWS CLI
  unarchive:
    src: "https://awscli.amazonaws.com/awscli-exe-linux-{{ansible_architecture}}.zip"
    dest: "{{temp_dir}}"
    remote_src: yes
  register: unarchive_awscli

- name: Install AWS CLI
  shell: "{{unarchive_awscli.dest}}/aws/install --update"
  become: yes

- name: Install NodeJS
  import_role:
    name: geerlingguy.nodejs
  become: yes

- name: Install Yarn
  npm:
    name: yarn
    global: yes
  become: yes

# Copied from https://github.com/geerlingguy/ansible-role-go/pull/2/files#diff-3d0ff1709ca48add100327bb2a468e6c508fb92a159c64c4f99ad1df89d9bddeR2-R15
# TODO: remove it when this PR is merged
- name: Check Go version
  command: /usr/local/go/bin/go version
  ignore_errors: yes
  register: go_version_result
  changed_when: false

- name: Remove current Go installation
  file:
    state: absent
    path: /usr/local/go
  when:
    - go_version_result is succeeded
    - go_version not in go_version_result.stdout
  become: yes

- name: Install Go
  import_role:
    name: geerlingguy.go
  vars:
    go_platform: linux
    go_arch: "{{ packages_architecture }}"
  become: yes

- name: Install diff-so-fancy
  npm:
    name: diff-so-fancy
    global: yes
  become: yes

- name: Configure diff-so-fancy in git config
  git_config:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    scope: global
  loop: "{{ config | dict2items }}"
  vars:
    config:
      core.pager: "diff-so-fancy | less --tabs=4 -RFX"
      interactive.diffFilter: "diff-so-fancy --patch"
      color.ui: "true"
      color.diff-highlight.oldNormal: "red bold"
      color.diff-highlight.oldHighlight: "red bold 52"
      color.diff-highlight.newNormal: "green bold"
      color.diff-highlight.newHighlight: "green bold 22"
      color.diff.meta: "11"
      color.diff.frag: "magenta bold"
      color.diff.func: "146 bold"
      color.diff.commit: "yellow bold"
      color.diff.old: "red bold"
      color.diff.new: "green bold"
      color.diff.whitespace: "red reverse"

- name: Check latest Lens version
  uri:
    url: https://api.k8slens.dev/binaries/latest.json
  register: lens_latest_version_response

- name: Extract latest Lens version
  set_fact:
    latest_lens_version: "{{ lens_latest_version_response.json.version }}"

- name: Check installed Lens version
  shell: dpkg -s lens | grep '^Version:' | cut -d ' ' -f 2-
  register: installed_lens_version_check_command

- name: Decide if should install Lens
  set_fact:
    should_install_lens: "{{ installed_lens_version_check_command is failed or installed_lens_version_check_command.stdout == '' or installed_lens_version_check_command.stdout is version(latest_lens_version, '<') }}"

- name: Download Lens
  get_url:
    url: "https://api.k8slens.dev/binaries/Lens-{{ latest_lens_version }}.{{ packages_architecture }}.deb"
    dest: "{{temp_dir}}"
    mode: "444"
  become: yes
  when: should_install_lens
  register: download_lens

- name: Install Lens
  apt:
    deb:  "{{ download_lens.dest }}"
  become: yes
  when: should_install_lens

- name: Install developer tools (snap - classic)
  snap:
    name:
    - kubectl
    - helm
    classic: yes
  become: yes

- name: "Evaluate completions for bash"
  shell: |
    "{{ item }}" completion bash | tee $HOME/.{{ item }}_bash_completion
    echo 'source $HOME/.{{ item }}_bash_completion' >> "{{ user_bash_completion_file_path }}"
  loop:
    - kubectl
    - helm
    - eksctl

- name: "Evaluate completions for zsh"
  shell: |
    "{{ item }}" completion zsh | tee $HOME/.{{ item }}_zsh_completion
    echo 'source $HOME/.{{ item }}_zsh_completion' >> "{{ user_zsh_completion_file_path }}"
  loop:
    - kubectl
    - helm

- name: Create temporary file for pyenv loading
  ansible.builtin.tempfile:
    state: file
  register: tempfile_for_pyenv_loading

- name: Install pyenv
  import_role:
    name: avanov.pyenv
  vars:
    pyenv_setting_path: "{{ tempfile_for_pyenv_loading.path }}"

- name: Add pyenv path to PATH in user bashrc
  ansible.builtin.blockinfile:
    block: |
      {{ lookup('file', tempfile_for_pyenv_loading.path) }}
      eval "$(pyenv init --path)"
    path: "{{user_bashrc_file_path}}"

- name: Save pyenv loading to fill in zshrc
  set_fact:
    pyenv_loading_for_zshrc: |
      {{ lookup('file', tempfile_for_pyenv_loading.path) }}
      eval "$(pyenv init --path)"

- name: Install ansible-lint
  pip:
    name: "ansible-lint[core,community,yamllint]"
  become: yes

- name: Install Terraform CLI
  import_role:
    name: robertdebock.terraform
  when: computer_type == "work"
  become: yes

- name: Install snapcraft
  snap:
    name: snapcraft
    classic: yes
  when: computer_type == "work"
  become: yes

- name: Install zsh-completions (homebrew)
  community.general.homebrew:
    name: zsh-completions
    state: present
  register: install_zsh_completions

- name: Update zsh-completions (homebrew)
  community.general.homebrew:
    name: zsh-completions
    state: latest

- name: Force-rebuild zcompdump to activate zsh completions
  shell: zsh -ic 'rm -f ~/.zcompdump; compinit'
  when: install_zsh_completions.changed

- name: Install developer tools (homebrew)
  community.general.homebrew:
    name:
    - derailed/k9s/k9s
    - fblog
    - weaveworks/tap/eksctl
    - kubectx
    - fzf
    state: latest

- name: Install buf
  community.general.homebrew:
    name: bufbuild/buf/buf
    state: latest
  when: computer_type == "work"

# TODO add VirtualBox, gitignore